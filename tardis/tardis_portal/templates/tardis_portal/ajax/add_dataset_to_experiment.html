{# add dataset to existing experiments #}
{# used for mrtardis app, but can imagine many other uses #}


<script type="text/javascript">
$(document).ready(function() {
    $("#demo1").jstree({
	core : { /* core options go here */ },
	plugins : [ "themes", "html_data", "checkbox" ]
    });
    //Get checked
    $('.add_files').live('click', function(){
	file_list = $(this).parents(".dataset_container").find(".dataset");
	local_id = $(this).parents(".dataset_container").attr("id");
	$(".jstree-leaf.jstree-checked").each(function(){
	    exists = false;
	    id = $(this).attr('id');
	    file_list.find(".file").each(function(){
		if(id == $(this).html())
		{
		    exists = true;
		}
	    });
	    if(!exists)
	    {
		file_list.append("<input type=\"hidden\" name=\"file_filename[" +
				 local_id + "]\" value=\"" + id +
				 "\"/> <li><span class=\"file\">" + id +
				 "</span> <span class=\"remove_file\">[x]</span></li>");
	    }
	});
    });

    //hide the all of the element with class msg_body
    //toggle the componenet with class msg_body
    $(".msg_head").live('click', function() {
	if($(this).next(".msg_body").is(':visible'))
	{
	    $(this).css('background-color', '#878787');
	    $(this).css('color', 'white');
	    $(this).next(".msg_body").hide();
	}
	else
	{
	    $(this).css('background-color', '#dcdcdc');
	    $(this).css('color', '#404040');
	    $(this).next(".msg_body").show();
	}
    });
    dataset_id = 1
    $(".add_new_dataset").click(function() {
	//$(this).siblings(".datasets").find(".dataset_container").first().clone().appendTo(".datasets").find('.dataset').html('');
	dataset_code = "<div class=\"dataset_container\" id=\"" + dataset_id + "\">" +
	    "	<p class=\"msg_head\">Dataset</p>" +
	    "	<div class=\"msg_body\">" +
	    "		<p>Dataset Description: <br/><textarea name=\"dataset_description[" + dataset_id + "]\" cols=\"80\" rows=\"2\"></textarea></p>" +
	    "		<p><input class=\"add_files\" type=\"button\" value=\"Add selected files to dataset\"/></p>" +
	    "		<p><strong>Files</strong></p>" +
	    "		<div>" +
	    "" +
	    "			<ul class=\"dataset\">" +
	    "			" +
	    "			</ul>" +
	    "		</div>				" +
	    "		<div style=\"text-align: right\" class=\"remove_dataset\">(Remove Dataset)</div>" +
	    "	</div>" +
	    "</div>";
	$(this).siblings(".datasets").append(dataset_code)
	$("#" + dataset_id).find('.dataset').html('');
	dataset_id = dataset_id + 1;
    });
    $(".remove_dataset").live('click', function() {
	if($(".dataset_container").size() > 1)
	{
	    $(this).parents(".dataset_container").remove();
	}
	else
	{
	    alert('experiments must have at least one dataset!');
	}
    });
    $(".remove_file").live('click', function() {
	$(this).parent().remove()
    });
});
</script>

<div class="post">
  <h1 class="title"><a name="abouttardis">Add Dataset to Experiment</a></h1>
  <div class="entry">
    <form action="/dataset/add/" method="POST">
      {{ form.non_field_errors }}
      <div class="msg_list">
	<p class="msg_head">Dataset Information</p>
	<div class="msg_body">

	  <div class="fieldWrapper">
	    {{ form.title.errors }}
	    <label for="id_title">Title:</label><br/>
	    {{ form.title }}
	  </div>

	  <div class="fieldWrapper">
	    {{ form.authors.errors }}
	    <label for="id_title">Authors (comma separate):</label><br/>
	    {{ form.authors }}
	  </div>

	  <div class="fieldWrapper">
	    {{ form.description.errors }}
	    <label for="id_description">Description:</label><br/>
	    {{ form.description }}
	  </div>

	  <div class="fieldWrapper">
	    {{ form.ownership.errors }}
	    <label for="id_description">Own data:</label><br/>
	    {{ form.ownership }}
	  </div>

	  <input name="url" type="hidden" value="http://remove.me"/>
	  <input name="created_by" type="hidden" value="{{user.id}}"/>

	</div>

	<p class="add_new_dataset">Add New Dataset</p>
	<p class="msg_head">My Files</p>
	<div class="msg_body">
	  <p><strong>Select Files For New Dataset</strong></p>
	  <div id="demo1" class="demo">

	    {{directory_listing|safe}}

	  </div>
	  <br/>
	</div>
	<div class="datasets">
	  {% for dataset_form, file_forms in form.get_datasets %}
	    <div class="dataset_container" id="0">
	      <p class="msg_head">Dataset</p>
	      <div class="msg_body">
		<div class="fieldWrapper">
		  {{ dataset_form.description.errors }}
		  <p>Dataset Description: <br/>
		  {% if dataset_form.is_bound %}{{dataset_form.id}}{% endif %}
		  {{dataset_form.description}}
		  </p>
		</div>
		<p><input class="add_files" type="button"
		value="Add selected files to dataset"/></p>
		<p><strong>Files</strong></p>
		<div>

		  <ul class="dataset">
		    {% for file_form in file_forms %}
		      {{file_form.url.as_hidden}}
		      <span class="file">{{file_form.url.as_label}}</span>
		      <span class="remove_file">[x]</span><br/>
		    {% endfor %}
		  </ul>
		</div>
		<div style="text-align: right" class="remove_dataset">(Remove Dataset)</div>
	      </div>
	    </div>
	  {% endfor %}
	</div>
	<br/>
	<input id="button" type="submit" value="Add Dataset"/>
      </div>

    </form>
  </div>
</div>


