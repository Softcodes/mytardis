<div id="mrtardisapp">
<script type="text/javascript">
$(document).ready(function() {

    // testing user's HPC readiness and showing setup help if they are not set up
    var username = "{{ hpc_username }}";

    function changeUserForm() {
	$("#HPCset-up").hide();
	$.ajax({
	    url: "{% url tardis.apps.mrtardis.views.test_user_setup experiment_id %}",
	    success: function(data){
		$("#setupHPC").html(data);
		$("#setupHPC").show();
		//$("#mrtardis").hide();
	    },
	    dataType: "html",
	});
    }

    if (username == "False") {
	changeUserForm();
    } else {
        $("#mrtardis").show();
	$("#HPCset-up").show();
	$("#setupHPC").hide();
    }

    $("a[href=#changeUsername]").bind('click', function(event) {
	event.preventDefault();
	changeUserForm();
    });

    $("a[href=#cancel]").bind('click', function(event) {
        event.preventDefault();
        $.ajax({
            type: "GET",
            dataType: "html",
            url: "{% url tardis.apps.mrtardis.views.index experiment_id %}",
            success: function(data) {
                $("#mrtardisapp").html(data);
            },
        });
    });

    $("#cancelbutton").hide();
    function showcancel() {
        $("#cancelbutton").show();
    }

    // responding to the different requests/forms
    function respondToForm(postdata) {
	$.ajax({
        type: "POST",
	    url: "{% url tardis.apps.mrtardis.views.MRform experiment_id %}",
	    data: postdata,
	    success: function(data) {
		    $("#mrtardis").html(data);
            showcancel();
	    }
	});
    }
    $("form[id=newDS]").bind("submit", function() {
	postdata = {'action': 'newDS',
		    'description': $("#newDS #id_description").val(),
		   }
	respondToForm(postdata);
	return false;
    });
    $("form[id=continueDS]").bind("submit", function() {
	postdata = {'action': 'continue',
		    'dataset': $("#continueDS #id_dataset").val(),
		   }
	respondToForm(postdata);
	return false;
    });
    $("form[id=rerunDS]").bind("submit", function() {
	postdata = {'action': 'rerunDS',
		    'dataset': $("#rerunDS #id_dataset").val(),
                    'description': $("#rerunDS #id_description").val(),
		   }
	respondToForm(postdata);
	return false;
    });

    // different url for displaying data
    $("form[id=viewDS]").bind("submit", function() {
	postdata = {'action': 'viewDS',
		    'dataset': $("#viewDS #id_dataset").val(),
		   }
	$.ajax({
	    type: "POST",
	    url: "{% url tardis.apps.mrtardis.views.displayResults experiment_id %}",
	    data: postdata,
	    success: function(data) {
		$("#mrtardis").html(data);
                showcancel();
	    }
	});
	return false;
    });


});
</script>
<p id="cancelbutton" style="text-align:right;"><a href="#cancel">Cancel</a></p>
{% if hpc_error %}
<p><b>There was an error with the HPC connection</b><br/>
Please check your username. If the problem persists, please contact the myTardis administrator and provide the following error message: {{ hpc_error }}</p>
{% endif %}
<p id="setupHPC"></p>
<div id="mrtardis">
  <h2>Simple Molecular Replacements on the Monash Grid</h2>
  <h3>Please select what you would like to do next:</h3>
  <p>
    <b>Set up a new run</b>
    <form id="newDS">{{ newDSForm }}
    <input type="submit" value="Create" />
    </form>
  </p>
  {% if continueForm %}
    <p>
      <b>Continue an interrupted setup</b>
      <form id="continueDS">{{ continueForm }}
      <input type="submit" value="Continue" />
      </form>
    </p>
  {% endif %}
  {% if viewForm %}
    <p>
      <b>View the results of finished runs</b>
      <form id="viewDS">{{ viewForm }}
      <input type="submit" value="Show Results" />
      </form>
    </p>
  {% endif %}
  {% if rerunForm %}
    <p>
      <b>New MR based on previous one</b><br/>
      Enter a new description
      <form id="rerunDS">Based on {{ rerunForm }} <br/>
      {{ newDSForm }}
      <input type="submit" value="Clone and edit" />
      </form>
    </p>
  {% endif %}

<!-- debug only
  <p style="text-align:right;font-size:80%;">
    Experiment id: {{ experiment_id }}
  </p> -->
</div>
<p id="HPCset-up" style="text-align: right; font-size:80%;">
Your HPC resource is set up and ready to use. You are using authcate username {{ hpc_username }} on the Monash Sun Grid.<br /><a href="#changeUsername" >Change username</a>
</p>
<p id="cancelbutton"><a href="#cancel">Cancel</a></p>
</div>
